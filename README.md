# Dense Canopy Tree Crown Instance Segmentation

## TODOs:

There is a sneaky modification in : `/home/ubuntu/drone-tree-id/lib/detectron2/detectron2/checkpoint/c2_model_loading.py` fix at some point

<div align="center">
  <img src="docs/home.png"/>
</div>

## Framework Structure
* `configs/` - definition of config files, which defines architecture, pretrained model to load, hyperparameters...
* `lib/` - libraries and dependencies
* `deepent/` - our library
    * `data` - module for data preprocessing and processing for training and evaluation
    * `modelling` - model architectures
* `output/` - files generated by framework such as models, logs, summaries, checkpoints ...
* `notebooks/` - documentation logbooks
* `setup` - setup script
* `tools/` - tools
    * `train_net.py` - trianing procedure
    * `vis.py` - a tool for creating visualizations
* `MODEL_ZOO.md`

## Environments

### AWS

Remember to load the pytorch build:
```
source activate pytorch_p36
```

### Setup

1. Clone repo:
```
cd ~
git clone https://github.com/roeetal/drone-tree-id.git
```
2. run setup script:
```
cd ~/drone-tree-id
chmod +x setup
./setup
```

## Training

To train the model, run the training script with appropriate flags:
* `--config-file`: the config file to load
* `OUTPUT_DIR`: the output path directory, for example: output/<name of experiment>
For example:
```
python tools/train_net.py --config-file configs/deepent_rcnn_R_101_FPN.yaml OUTPUT_DIR path/to/output/dir
```

## Evaluation

To evaluation the model, run the training script with appropriate flags:
* `--config-file`: the config file to load
* `MODEL.WEIGHTS`: the weight file to load
For example:
```
python tools/train_net.py --config-file /home/ubuntu/drone-tree-id/configs/deepent_rcnn_R_50_FPN.yaml --eval-only MODEL.WEIGHTS /home/ubuntu/drone-tree-id/output/model_0034999.pth
```

## Benchmarking
To benchmark training or evalutation sessions:
```
python benchmark.py --config-file configs/deepent_rcnn_R_50_FPN.yaml --task train
```


## Visualization

To create a 6x2 sample visualization of model inference, run the following with the appropriate arguments:
* `--config-file`: the config file to load
* `--model`: the weight file to load`
* `--dataset`: name of the dataset
* `--threshold`: confidence threshold
* `--samples`: number of sample visualizations to produce
* `--output`: path to store visualizations
* `--seed`: use random seed or config seed
```
python tools/vis.py --threshold 0.5 --config-file configs/deepent_fuse_rcnn_R_50_FPN.yaml --samples 5 --output output/baseline_fuse_07_02_2020/vis --type comparison --dataset CPT2a-n_test CPT2a-n_train  Kelowna_train Kelowna_test AMECT9_train AMECT9_test SALCT1_train SALCT1_test CPT2b_train CPT2b_test --model output/baseline_fuse_07_02_2020/model_0049999.pth
```
and then transfer
```
scp -r -i ~/.ssh/vm.pem ubuntu@ec2-54-226-164-33.compute-1.amazonaws.com:/home/ubuntu/drone-tree-id/output/baseline_17_01_2019/vis Desktop/vis
```
```shell script
python segment_trees.py 
--data 'path to my dataset(s)' # if empty will look at the tiles path
--plots ['CPT*', 'Twister', 'Kelowna'] # if empty will
--predictors ['alexis, sequoia', 'andrew', 'sequoia']  # if empty will use a default setting 'fuse, mask'
--confidence 0.5
--duplicate-threshold 0.85
--min-segment-area 2
```
